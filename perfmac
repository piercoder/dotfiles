#!/bin/zsh
###############################################################################
# perfmac — macOS Performance & Latency Tuner
#
# Description:
#   Optimizes macOS for maximum responsiveness by disabling or reducing
#   animations, tuning input delays, lowering compositor overhead, and applying
#   various Finder/Dock/system tweaks.
#
# Features:
#   - Low-latency UI + fast keyboard repeat rates
#   - Finder & Dock optimizations (Dock always visible)
#   - Optional aggressive cleanup of caches/logs
#   - Spotlight control (disable on external drives)
#   - Safe to run multiple times
#   - Supports dry-run mode
#
# Usage:
#   ./perfmac [options]
#
# Options:
#   -d    Dry run: print commands without executing
#   -a    Aggressive mode: deeper cache/log cleanup
#   -s    Skip software update checks
#   -h    Show usage/help
#
# Examples:
#   ./perfmac            # default optimizations
#   ./perfmac -a -s      # aggressive cleanup, skip updates
#   ./perfmac -d         # dry-run mode
#
# Author:
#   Pierpaolo Pattitoni — https://github.com/piercoder
#
# License:
#   MIT License — See https://opensource.org/licenses/MIT
#
# Warning:
#   This script writes to system preferences and requires sudo for some tasks.
#   Review the code before running. Use at your own risk.
###############################################################################

set -e
set -u
set -o pipefail

DRY_RUN=0
AGGRESSIVE=0
SKIP_UPDATES=0

usage() {
  echo "Usage: perfmac [options]"
  echo
  echo "Options:"
  echo "  -d    Dry run: show what would be done, without making changes"
  echo "  -a    Aggressive mode: deeper cache/log cleanups (caches will rebuild)"
  echo "  -s    Skip software updates to save time"
  echo "  -h    Show this help"
  echo
  echo "Examples:"
  echo "  ./perfmac          # run with defaults"
  echo "  ./perfmac -a -s    # aggressive clean + skip updates"
  echo "  ./perfmac -d       # dry run (no changes)"
}

while getopts "dash" opt; do
  case "$opt" in
    d) DRY_RUN=1 ;;
    a) AGGRESSIVE=1 ;;
    s) SKIP_UPDATES=1 ;;
    h) usage; exit 0 ;;
    *) usage; exit 1 ;;
  esac
done
shift $((OPTIND-1))

# --- utils ---
readonly GREEN=$'\033[32m'; readonly YELLOW=$'\033[33m'; readonly DIM=$'\033[2m'; readonly RESET=$'\033[0m'
readonly SUDO="${SUDO:-sudo}"

log()  { printf "%s•%s %s\n" "$GREEN" "$RESET" "$*"; }
warn() { printf "%s!%s %s\n"  "$YELLOW" "$RESET" "$*"; }
run()  { if [[ "$DRY_RUN" == "1" ]]; then printf "%sDRY:%s %s\n" "$DIM" "$RESET" "$*"; else eval "$@"; fi }

require_macos() {
  if ! command -v sw_vers >/dev/null; then echo "This script targets macOS."; exit 1; fi
  local ver; ver="$(sw_vers -productVersion)"
  log "Detected macOS ${ver}"
}

need_tools() {
  for cmd in defaults killall mdutil diskutil softwareupdate; do
    if ! command -v "$cmd" >/dev/null; then echo "Missing required tool: $cmd"; exit 1; fi
  done
}

write_default() {
  local domain="$1" key="$2" type="$3" value="$4"
  log "defaults write ${domain} ${key} (-${type}) => ${value}"
  run "/usr/bin/defaults write '${domain}' '${key}' -${type} ${value}"
}
write_default_global() { write_default "NSGlobalDomain" "$@"; }

host_default() {
  local domain="$1" key="$2" type="$3" value="$4"
  log "defaults -currentHost write ${domain} ${key} (-${type}) => ${value}"
  run "/usr/bin/defaults -currentHost write '${domain}' '${key}' -${type} ${value}"
}

restart_if_running() { for app in "$@"; do run "killall '${app}' 2>/dev/null || true"; done }

# Robust zsh implementation (works with set -u)
apply_specs() {
  # $1 is a newline-separated spec string: "domain|key|type|value"
  local -a specs; specs=("${(f)1}")   # split on newlines
  local line domain key type value _
  for line in "${specs[@]}"; do
    [[ -z "$line" ]] && continue
    IFS='|' read -r domain key type value <<< "$line"
    if [[ "$domain" == "HOST" ]]; then
      IFS='|' read -r _ domain key type value <<< "$line"
      host_default "$domain" "$key" "$type" "$value"
    elif [[ "$domain" == "NSGlobalDomain" ]]; then
      write_default_global "$key" "$type" "$value"
    else
      write_default "$domain" "$key" "$type" "$value"
    fi
  done
}

# --- preflight ---
require_macos
need_tools

# Summary banner
echo "======================================="
echo " perfmac run summary"
echo " - Dry run:        $([[ ${DRY_RUN:-0} -eq 1 ]] && echo YES || echo NO)"
echo " - Aggressive:     $([[ ${AGGRESSIVE:-0} -eq 1 ]] && echo YES || echo NO)"
echo " - Skip updates:   $([[ ${SKIP_UPDATES:-0} -eq 1 ]] && echo YES || echo NO)"
echo "======================================="

# --- specs ---
UI_SPECS=$'
NSGlobalDomain|ApplePressAndHoldEnabled|bool|false
NSGlobalDomain|KeyRepeat|int|1
NSGlobalDomain|InitialKeyRepeat|int|15
NSGlobalDomain|NSAutomaticWindowAnimationsEnabled|bool|false
NSGlobalDomain|NSWindowResizeTime|float|0.001
NSGlobalDomain|NSScrollAnimationEnabled|bool|false
NSGlobalDomain|NSToolbarTitleViewRolloverDelay|float|0
NSGlobalDomain|WebKitScrollAnimationsEnabled|bool|false
NSGlobalDomain|NSScrollViewRubberbanding|bool|false
NSGlobalDomain|QLPanelAnimationDuration|float|0
'

ACCESSIBILITY_SPECS=$'
com.apple.universalaccess|reduceTransparency|bool|true
com.apple.universalaccess|reduceMotion|bool|true
com.apple.universalaccess|showWindowTitlebarIcons|bool|true
'

DOCK_SPECS=$'
com.apple.dock|autohide|bool|false
com.apple.dock|launchanim|bool|false
com.apple.dock|mineffect|string|scale
com.apple.dock|expose-animation-duration|float|0
com.apple.dock|show-recents|bool|false
com.apple.dock|mru-spaces|bool|true
com.apple.dock|tilesize|int|44
com.apple.dock|orientation|string|bottom
com.apple.dock|static-only|bool|true
'

FINDER_SPECS=$'
com.apple.finder|FXPreferredViewStyle|string|Nlsv
com.apple.finder|ShowPathbar|bool|true
com.apple.finder|ShowStatusBar|bool|true
com.apple.finder|_FXSortFoldersFirst|bool|true
com.apple.finder|_FXSortFoldersFirstOnDesktop|bool|true
com.apple.finder|FXRemoveOldTrashItems|bool|true
com.apple.finder|FXEnableExtensionChangeWarning|bool|false
com.apple.finder|QuitMenuItem|bool|true
com.apple.finder|AppleShowAllFiles|bool|true
com.apple.finder|CreateDesktop|bool|true
com.apple.finder|FXDefaultSearchScope|string|SCcf
'

SCREENSHOT_SPECS=$'
com.apple.screencapture|disable-shadow|bool|true
com.apple.screencapture|include-date|bool|true
com.apple.screencapture|show-thumbnail|bool|false
com.apple.screencapture|type|string|png
com.apple.screencapture|location|string|'${HOME}'/Desktop
'

APPS_SPECS=$'
com.apple.ActivityMonitor|IconType|int|5
com.apple.ActivityMonitor|UpdatePeriod|int|2
com.apple.TextEdit|RichText|bool|false
com.apple.Music|userWantsPlaybackNotifications|bool|false
HOST|com.apple.ImageCapture|disableHotPlug|bool|true
'

# --- apply settings ---
log "Applying low-latency UI settings…"
apply_specs "$UI_SPECS"

log "Reducing compositor overhead (Accessibility)…"
run "${SUDO} /usr/bin/defaults write com.apple.universalaccess reduceTransparency -bool true"
run "${SUDO} /usr/bin/defaults write com.apple.universalaccess reduceMotion -bool true"
run "${SUDO} /usr/bin/defaults write com.apple.universalaccess showWindowTitlebarIcons -bool true"

log "Tuning Dock (visible)…"
apply_specs "$DOCK_SPECS"

log "Optimizing Finder…"
apply_specs "$FINDER_SPECS"

log "Configuring Screenshots…"
apply_specs "$SCREENSHOT_SPECS"

log "Tuning common apps & services…"
apply_specs "$APPS_SPECS"

# --- Spotlight tweaks ---
log "Adjusting Spotlight (keep on system drive; disable on externals)…"
for vol in /Volumes/*; do
  if [[ ! -e "$vol" ]]; then continue; fi
  if [[ -L "$vol" ]]; then continue; fi
  if diskutil info "$vol" 2>/dev/null | grep -q "External:.*Yes"; then
    warn "Disabling Spotlight on external volume: $vol"
    run "${SUDO} /usr/bin/mdutil -i off '$vol' 2>/dev/null || true"
  fi
done
run "${SUDO} /usr/bin/mdutil -i on / 2>/dev/null || true"

# --- Login/window restore behavior ---
log "Disabling app relaunch after login/logout…"
write_default com.apple.loginwindow TALLogoutSavesState bool false
write_default com.apple.loginwindow LoginwindowLaunchesRelaunchApps bool false

# --- Maintenance (safe) ---
log "Running safe maintenance…"
if [[ "$SKIP_UPDATES" != "1" ]]; then
  warn "Checking for software updates (may take a while)…"
  run "softwareupdate -ia --verbose || true"
fi

LSREGISTER="/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister"
if [[ -x "$LSREGISTER" ]]; then
  log "Rebuilding Launch Services database…"
  run "'$LSREGISTER' -kill -r -domain local -domain system -domain user"
fi

log "Rotating logs (periodic daily/weekly/monthly)…"
run "${SUDO} periodic daily weekly monthly || true"

# --- Aggressive mode (optional) ---
if [[ "$AGGRESSIVE" == "1" ]]; then
  warn "AGGRESSIVE=1 — deeper cache/log cleanups enabled"
  run "${SUDO} rm -rf /Library/Caches/* 2>/dev/null || true"
  run "rm -rf '${HOME}/Library/Caches/'* 2>/dev/null || true"
  run "${SUDO} rm -rf /Library/Logs/* 2>/dev/null || true"
  run "rm -rf '${HOME}/Library/Logs/'* 2>/dev/null || true"
  run "${SUDO} rm -rf /private/var/log/* 2>/dev/null || true"
  run "rm -rf '${HOME}/Library/Caches/com.apple.QuickLook.thumbnailcache' 2>/dev/null || true"
  run "qlmanage -r cache 2>/dev/null || true"
  run "rm -rf '${HOME}/Library/Preferences/com.apple.dock.db' 2>/dev/null || true"
fi

# --- Apply & restart affected agents ---
log "Restarting agents to apply changes…"
run "killall cfprefsd 2>/dev/null || true"
restart_if_running Dock Finder SystemUIServer Activity\\ Monitor TextEdit Music

echo
log "Done. Tip: Reboot to fully apply Spotlight/LaunchServices changes."